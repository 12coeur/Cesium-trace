<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Trace CesiumJS</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.122/Cesium.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.122/Widgets/widgets.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/togeojson/0.16.0/togeojson.min.js"></script>
  <style>
    html, body, #map { width:100%; height:100%; margin:0; padding:0; }
    #info { position:absolute; top:10px; left:10px; background:rgba(0,0,0,0.5); color:white; padding:5px; font-size:14px; z-index:10; }
  </style>
</head>
<body>
  <div id="info">Affichage automatique de <b>traces/test.gpx</b></div>
  <div id="map"></div>

  <script>
    // === Initialisation Cesium ===
    const viewer = new Cesium.Viewer("map", {
      terrainProvider: Cesium.createWorldTerrain(),
      timeline: false,
      animation: false,
      baseLayerPicker: false
    });
    viewer.scene.globe.terrainExaggeration = 1.2;

    // === Fonction d’affichage ===
    function showTrace(coords, name) {
      if (coords.length < 2) return;

      // Ligne
      const positions = Cesium.Cartesian3.fromDegreesArrayHeights(coords.flat());
      viewer.entities.add({
        name,
        polyline: {
          positions,
          width: 3,
          material: Cesium.Color.YELLOW.withAlpha(0.9)
        }
      });

      // Départ / Arrivée
      const start = coords[0];
      const end = coords[coords.length - 1];
      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(...start),
        point: { pixelSize: 10, color: Cesium.Color.GREEN },
        label: { text: `Départ: ${Math.round(start[2])}m`, font: "14px sans-serif", fillColor: Cesium.Color.WHITE }
      });
      viewer.entities.add({
        position: Cesium.Cartesian3.fromDegrees(...end),
        point: { pixelSize: 10, color: Cesium.Color.RED },
        label: { text: `Arrivée: ${Math.round(end[2])}m`, font: "14px sans-serif", fillColor: Cesium.Color.WHITE }
      });

      viewer.zoomTo(viewer.entities);
    }

    // === Charger automatiquement un fichier GPX/KML/IGC ===
    async function loadTrace(url) {
      const response = await fetch(url);
      if (!response.ok) {
        document.getElementById("info").innerText = "Erreur : impossible de charger " + url;
        return;
      }
      const text = await response.text();
      const ext = url.split(".").pop().toLowerCase();
      let coords = [];

      if (ext === "gpx" || ext === "kml") {
        const xml = new DOMParser().parseFromString(text, "text/xml");
        const geojson = ext === "gpx" ? toGeoJSON.gpx(xml) : toGeoJSON.kml(xml);
        geojson.features.forEach(f => {
          if (f.geometry.type === "LineString") {
            coords.push(...f.geometry.coordinates.map(c => [c[0], c[1], c[2] || 0]));
          }
        });
      } else {
        document.getElementById("info").innerText = "Format non supporté en auto-chargement";
        return;
      }

      if (coords.length > 1) {
        showTrace(coords, url);
        document.getElementById("info").innerText = "Trace chargée : " + url;
      } else {
        document.getElementById("info").innerText = "Aucune donnée exploitable dans " + url;
      }
    }

    // Charger la trace par défaut
    loadTrace("traces/test.gpx");
  </script>
</body>
</html>
