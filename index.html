<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Visualisation de traces GPS</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        html, body, #map { 
            width: 100%; 
            height: 100%; 
            margin: 0; 
            padding: 0; 
        }
        #controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            z-index: 1000;
            font-family: sans-serif;
            max-width: 300px;
        }
        #info {
            margin-top: 8px;
            font-size: 12px;
            color: #666;
        }
    </style>
</head>
<body>
    <div id="controls">
        <input type="file" id="fileInput" accept=".gpx,.kml,.igc">
        <div id="info">Choisissez un fichier IGC, GPX ou KML</div>
    </div>
    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Initialisation de la carte Leaflet
        const map = L.map('map').setView([46.0, 2.0], 5); // Centre sur la France
        
        // Ajout de la couche OpenStreetMap
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // Groupe pour les traces
        const trackGroup = L.layerGroup().addTo(map);

        function clearMap() {
            trackGroup.clearLayers();
        }

        function showTrace(coords, name) {
            if (coords.length < 2) {
                alert('Trace trop courte');
                return;
            }

            clearMap();

            // Conversion des coordonnÃ©es pour Leaflet [lat, lng]
            const latLngs = coords.map(coord => [coord[1], coord[0]]);

            // CrÃ©ation de la ligne
            const polyline = L.polyline(latLngs, {
                color: 'red',
                weight: 4,
                opacity: 0.7
            }).addTo(trackGroup);

            // Points de dÃ©part et d'arrivÃ©e
            if (latLngs.length > 0) {
                const start = latLngs[0];
                const end = latLngs[latLngs.length - 1];
                
                L.marker(start, {
                    icon: L.divIcon({
                        className: 'start-marker',
                        html: 'ðŸŸ¢',
                        iconSize: [20, 20]
                    })
                }).addTo(trackGroup).bindPopup('Point de dÃ©part');
                
                L.marker(end, {
                    icon: L.divIcon({
                        className: 'end-marker',
                        html: 'ðŸ”´',
                        iconSize: [20, 20]
                    })
                }).addTo(trackGroup).bindPopup('Point d\'arrivÃ©e');

                // Ajustement de la vue
                map.fitBounds(polyline.getBounds());
            }

            document.getElementById('info').textContent = `${name} - ${coords.length} points`;
        }

        // Parsing IGC
        function parseIGC(content) {
            const lines = content.split('\n');
            const coords = [];
            
            lines.forEach(line => {
                if (line.startsWith('B') && line.length >= 35) {
                    try {
                        const latStr = line.substring(7, 15);
                        const lonStr = line.substring(15, 24);
                        const altStr = line.substring(30, 35);

                        // Latitude
                        const latDeg = parseInt(latStr.substring(0, 2));
                        const latMin = parseFloat(latStr.substring(2, 7)) / 1000;
                        let lat = latDeg + latMin / 60;
                        if (latStr.charAt(7) === 'S') lat = -lat;

                        // Longitude
                        const lonDeg = parseInt(lonStr.substring(0, 3));
                        const lonMin = parseFloat(lonStr.substring(3, 8)) / 1000;
                        let lon = lonDeg + lonMin / 60;
                        if (lonStr.charAt(8) === 'W') lon = -lon;

                        // Altitude
                        const alt = parseInt(altStr);

                        if (!isNaN(lat) && !isNaN(lon)) {
                            coords.push([lon, lat, alt || 0]);
                        }
                    } catch (e) {
                        console.warn('Erreur parsing ligne IGC:', line);
                    }
                }
            });
            
            return coords;
        }

        // Parsing GPX
        function parseGPX(content) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(content, 'text/xml');
            const coords = [];
            
            const trkpts = xmlDoc.getElementsByTagName('trkpt');
            for (let i = 0; i < trkpts.length; i++) {
                const pt = trkpts[i];
                const lat = parseFloat(pt.getAttribute('lat'));
                const lon = parseFloat(pt.getAttribute('lon'));
                const eleElem = pt.getElementsByTagName('ele')[0];
                const ele = eleElem ? parseFloat(eleElem.textContent) : 0;
                
                if (!isNaN(lat) && !isNaN(lon)) {
                    coords.push([lon, lat, ele]);
                }
            }
            
            return coords;
        }

        // Parsing KML
        function parseKML(content) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(content, 'text/xml');
            const coords = [];
            
            const coordinates = xmlDoc.getElementsByTagName('coordinates');
            if (coordinates.length > 0) {
                const coordText = coordinates[0].textContent.trim();
                const points = coordText.split(/\s+/);
                
                points.forEach(point => {
                    if (point) {
                        const [lon, lat, alt] = point.split(',').map(Number);
                        if (!isNaN(lon) && !isNaN(lat)) {
                            coords.push([lon, lat, alt || 0]);
                        }
                    }
                });
            }
            
            return coords;
        }

        // Gestionnaire de fichier
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                let coords = [];
                const extension = file.name.split('.').pop().toLowerCase();
                
                document.getElementById('info').textContent = `Chargement de ${file.name}...`;
                
                try {
                    if (extension === 'igc') {
                        coords = parseIGC(content);
                    } else if (extension === 'gpx') {
                        coords = parseGPX(content);
                    } else if (extension === 'kml') {
                        coords = parseKML(content);
                    } else {
                        alert('Format non supportÃ©. Utilisez .igc, .gpx ou .kml');
                        return;
                    }
                    
                    if (coords.length > 0) {
                        showTrace(coords, file.name);
                    } else {
                        document.getElementById('info').textContent = 'Aucune trace valide trouvÃ©e';
                        alert('Aucune trace valide n\'a pu Ãªtre lue dans le fichier');
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    document.getElementById('info').textContent = 'Erreur de chargement';
                    alert('Erreur lors du chargement du fichier');
                }
            };
            
            reader.readAsText(file);
        });

        console.log('Carte Leaflet initialisÃ©e - PrÃªte Ã  charger des traces');
    </script>
</body>
</html>
