<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Visualisation de traces CesiumJS</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.122/Cesium.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/cesium/1.122/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body, #cesiumContainer { 
            width: 100%; 
            height: 100%; 
            margin: 0; 
            padding: 0; 
            overflow: hidden; 
        }
        #controls {
            position: absolute;
            top: 10px; 
            left: 10px;
            background: rgba(0,0,0,0.7);
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
            color: white;
            font-family: sans-serif;
        }
    </style>
</head>
<body>
    <div id="controls">
        <input type="file" id="fileInput" accept=".gpx,.kml,.igc">
        <div id="info" style="margin-top:8px; font-size:12px;">
            Choisissez un fichier IGC, GPX ou KML
        </div>
    </div>
    <div id="cesiumContainer"></div>

    <script>
        // Jeton Cesium Ion (gratuit)
        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJlYWE1OWUxNy1mMWZiLTQzYjYtYTQ0OS1kMWFjYmFkNjdjZTMiLCJpZCI6MTE2MzEsImlhdCI6MTY2Mjg5MjI2M30.6Gp2opp5j5lAZU1VcY7wS0VY6J4nFRCmWr-vkCwVY7s';

        // Initialisation de Cesium
        const viewer = new Cesium.Viewer('cesiumContainer', {
            terrainProvider: Cesium.createWorldTerrain(),
            baseLayerPicker: false,
            timeline: false,
            animation: false,
            homeButton: false,
            fullscreenButton: false,
            vrButton: false,
            geocoder: false,
            sceneModePicker: false,
            navigationHelpButton: false,
            selectionIndicator: false
        });

        // Fonction pour vider la scène
        function clearEntities() {
            viewer.entities.removeAll();
        }

        // Fonction d'affichage de la trace
        function showTrace(coords, name) {
            if (coords.length < 2) {
                alert('Trace trop courte');
                return;
            }

            clearEntities();

            // Conversion des coordonnées
            const positions = [];
            coords.forEach(coord => {
                positions.push(Cesium.Cartesian3.fromDegrees(coord[0], coord[1], coord[2]));
            });

            // Ligne de la trace
            viewer.entities.add({
                name: name,
                polyline: {
                    positions: positions,
                    width: 4,
                    material: Cesium.Color.YELLOW,
                    clampToGround: false
                }
            });

            // Point de départ (vert)
            viewer.entities.add({
                position: positions[0],
                point: {
                    pixelSize: 12,
                    color: Cesium.Color.GREEN,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2
                },
                label: {
                    text: 'Départ',
                    font: '14px sans-serif',
                    fillColor: Cesium.Color.WHITE,
                    outlineColor: Cesium.Color.BLACK,
                    outlineWidth: 2,
                    pixelOffset: new Cesium.Cartesian2(0, -20)
                }
            });

            // Point d'arrivée (rouge)
            viewer.entities.add({
                position: positions[positions.length - 1],
                point: {
                    pixelSize: 12,
                    color: Cesium.Color.RED,
                    outlineColor: Cesium.Color.WHITE,
                    outlineWidth: 2
                },
                label: {
                    text: 'Arrivée',
                    font: '14px sans-serif',
                    fillColor: Cesium.Color.WHITE,
                    outlineColor: Cesium.Color.BLACK,
                    outlineWidth: 2,
                    pixelOffset: new Cesium.Cartesian2(0, -20)
                }
            });

            // Zoom sur la trace
            viewer.zoomTo(viewer.entities);
        }

        // Parsing IGC
        function parseIGC(content) {
            const lines = content.split('\n');
            const coords = [];
            
            lines.forEach(line => {
                if (line.startsWith('B') && line.length >= 35) {
                    try {
                        const latStr = line.substring(7, 15);
                        const lonStr = line.substring(15, 24);
                        const altStr = line.substring(30, 35);

                        // Latitude
                        const latDeg = parseInt(latStr.substring(0, 2));
                        const latMin = parseFloat(latStr.substring(2, 7)) / 1000;
                        let lat = latDeg + latMin / 60;
                        if (latStr.charAt(7) === 'S') lat = -lat;

                        // Longitude
                        const lonDeg = parseInt(lonStr.substring(0, 3));
                        const lonMin = parseFloat(lonStr.substring(3, 8)) / 1000;
                        let lon = lonDeg + lonMin / 60;
                        if (lonStr.charAt(8) === 'W') lon = -lon;

                        // Altitude
                        const alt = parseInt(altStr);

                        if (!isNaN(lat) && !isNaN(lon) && !isNaN(alt)) {
                            coords.push([lon, lat, alt]);
                        }
                    } catch (e) {
                        console.warn('Erreur parsing ligne IGC:', line);
                    }
                }
            });
            
            return coords;
        }

        // Parsing GPX
        function parseGPX(content) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(content, 'text/xml');
            const coords = [];
            
            const trkpts = xmlDoc.getElementsByTagName('trkpt');
            for (let i = 0; i < trkpts.length; i++) {
                const pt = trkpts[i];
                const lat = parseFloat(pt.getAttribute('lat'));
                const lon = parseFloat(pt.getAttribute('lon'));
                const eleElem = pt.getElementsByTagName('ele')[0];
                const ele = eleElem ? parseFloat(eleElem.textContent) : 0;
                
                if (!isNaN(lat) && !isNaN(lon)) {
                    coords.push([lon, lat, ele]);
                }
            }
            
            return coords;
        }

        // Parsing KML
        function parseKML(content) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(content, 'text/xml');
            const coords = [];
            
            const coordinates = xmlDoc.getElementsByTagName('coordinates');
            if (coordinates.length > 0) {
                const coordText = coordinates[0].textContent.trim();
                const points = coordText.split(/\s+/);
                
                points.forEach(point => {
                    if (point) {
                        const [lon, lat, alt] = point.split(',').map(Number);
                        if (!isNaN(lon) && !isNaN(lat)) {
                            coords.push([lon, lat, alt || 0]);
                        }
                    }
                });
            }
            
            return coords;
        }

        // Gestionnaire de fichier
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                let coords = [];
                const extension = file.name.split('.').pop().toLowerCase();
                
                document.getElementById('info').textContent = `Chargement de ${file.name}...`;
                
                try {
                    if (extension === 'igc') {
                        coords = parseIGC(content);
                    } else if (extension === 'gpx') {
                        coords = parseGPX(content);
                    } else if (extension === 'kml') {
                        coords = parseKML(content);
                    } else {
                        alert('Format non supporté');
                        return;
                    }
                    
                    if (coords.length > 0) {
                        showTrace(coords, file.name);
                        document.getElementById('info').textContent = 
                            `${file.name} - ${coords.length} points chargés`;
                    } else {
                        document.getElementById('info').textContent = 'Aucune trace valide trouvée';
                    }
                } catch (error) {
                    console.error('Erreur:', error);
                    document.getElementById('info').textContent = 'Erreur de chargement';
                }
            };
            
            reader.readAsText(file);
        });

        // Message de bienvenue
        console.log('Cesium initialisé - Prêt à charger des traces');
    </script>
</body>
</html>
